zkex.menu.Fisheyebar=zk.$extends(zul.Widget,{_itemWidth:50,_itemHeight:50,_itemMaxWidth:200,_itemMaxHeight:200,_itemPadding:10,_orient:"horizontal",_attachEdge:"center",_labelEdge:"bottom",$init:function(){this.$supers("$init",arguments);this.units=2;this.subts=0.5;this.box={x:-1,y:-1,l:-1,r:-1,t:-1,b:-1}},$define:{itemWidth:_zkf=function(){if(this.$n()){this.syncAttr();this.onSize()}},itemHeight:_zkf,itemMaxWidth:_zkf,itemMaxHeight:_zkf,itemPadding:_zkf,orient:_zkf,attachEdge:_zkf,labelEdge:_zkf},getZclass:function(){var a=this._zclass;return a!=null?a:"z-fisheyebar"},bind_:function(){this.$supers(zkex.menu.Fisheyebar,"bind_",arguments);this._init();zWatch.listen({onSize:this,onResponse:this})},unbind_:function(){zWatch.unlisten({onSize:this,onResponse:this});jq(document).unbind("zmousemove",this._onMouseMove);jq(document).unbind("mouseout",this._onBodyOut);this.pbox=this._onMouseMove=this._onBodyOut=null;this.$supers(zkex.menu.Fisheyebar,"unbind_",arguments)},onResponse:function(){if(this.desktop&&this._shallSync){this.syncAttr();this.onSize();this._shallSync=false}},onChildAdded_:function(a){this.$supers("onChildAdded_",arguments);this._shallSync=true},onChildRemoved_:function(a){this.$supers("onChildRemoved_",arguments);this._shallSync=true},_init:function(){var b=this.$n();zk(b).disableSelection();this.syncAttr();var a=this;if(!this._onMouseMove){this._onMouseMove=function(d){var c=d.pageX,f=d.pageY;if((c>=a.box.l)&&(c<=a.box.r)&&(f>=a.box.t)&&(f<=a.box.b)){if(!a.active){a.active=true;a.onSize()}a._calc(c-a.box.l,f-a.box.t)}else{if(a.active){a.active=false;a._calc(-1,-1)}else{if(a._bodyX&&a._bodyY&&c<=a._bodyX+30&&c>=a._bodyX-30&&f<=a._bodyY+30&&f>=a._bodyY-30){return}a._bodyX=c;a._bodyY=f;var e=jq.now();if(!a._timer||a._timer<e){a._timer=e+1500;a.onSize()}}}}}if(!this._onBodyOut){this._onBodyOut=function(f){var d=f.pageX,j=f.pageY,i=zk(document.body).revisedOffset(),g=i[1],c=g+document.body.offsetHeight,e=i[0],h=e+document.body.offsetWidth;if(d>=e&&d<=h&&j>=g&&j<=c){return}a.active=false;a._calc(-1,-1)}}jq(document).bind("zmousemove",this._onMouseMove);jq(document).mouseout(this._onBodyOut)},getAttachEdge:function(){var a=this._attachEdge;return a=="center"||(this.isHor&&(a=="left"||a=="right"))||(!this.isHor&&(a=="top"||a=="bottom"))?"center":a},getLabelEdge:function(){var a=this._labelEdge;if(a=="center"||(this.isHor&&(a=="left"||a=="right"))){a="top"}else{if(!this.isHor&&(a=="top"||a=="bottom")){a="left"}}return a},getProximitybox:function(){var c=(this.units-this.subts),d=this.iw*c,f=d,e=this.ih*c,a=e;switch(this.aEdge){case"left":d=0;break;case"right":f=0;break;case"top":e=0;break;case"bottom":a=0;break;default:d/=2;f/=2;e/=2;a/=2}return{l:d,r:f,t:e,b:a}},syncAttr:function(){if(!this.$n()){return}this.icnt=this.nChildren;this.iw=this._itemWidth;this.ih=this._itemHeight;this.imw=this._itemMaxWidth;this.imh=this._itemMaxHeight;this.isHor=(this._orient=="horizontal");this.aEdge=this.getAttachEdge();this.lEdge=this.getLabelEdge();this.pbox=this.getProximitybox();this.ip=this._itemPadding;var v=(this.isHor?this.icnt:1)*this.iw,b=(this.isHor?1:this.icnt)*this.ih;this.tw=this.pbox.l+this.pbox.r+v;this.th=this.pbox.t+this.pbox.b+b;for(var t=0;t<this.icnt;t++){var e=this.getChildAt(t),c=e.$n(),w=e.$n("img"),j=this.iw*(this.isHor?t:0),g=this.ih*(this.isHor?0:t),k=c.style,d=w.style;c.cenX=j+(this.iw/2);c.cenY=g+(this.ih/2);var m=this.isHor?this.iw:this.ih,l=this.units*m,f=this.isHor?c.cenX:c.cenY,p=this.isHor?this.pbox.l:this.pbox.t,a=this.isHor?this.pbox.r:this.pbox.b,u=this.isHor?v:b;var h=l,q=l;if(h>f+p){h=f+p}if(q>(u-f+a)){q=u-f+a}c.effectRangeLeft=h/m;c.effectRangeRght=q/m;k.left=j+"px";k.top=g+"px";k.width=this.iw+"px";k.height=this.ih+"px";d.left=this.ip+"%";d.top=this.ip+"%";d.width=(100-2*this.ip)+"%";d.height=(100-2*this.ip)+"%"}var o=this.$n();o.style.width=v+"px";o.style.height=b+"px";this.onSize()},_calc:function(q,n){if(q<=this.box.x+4&&q>=this.box.x-4&&n<=this.box.y+4&&n>=this.box.y-4){return}this.box.x=q;this.box.y=n;if(this.icnt<=0){return}var o,h,c,p;if(this.isHor){o=q;h=this.pbox.l;c=this.iw;p=1*this.imw}else{o=n;h=this.pbox.t;c=this.ih;p=1*this.imh}var k=((o-h)/c)-this.subts,m=(p/c)-this.subts;if(m>this.units){m=this.units}var f=0,b=this.aEdge;switch(b){case"bottom":var l=(n-this.pbox.t)/this.ih;f=(l>this.subts)?1:n/(this.pbox.t+(this.ih/2));break;case"top":var l=(n-this.pbox.t)/this.ih;f=(l<this.subts)?1:(this.th-n)/(this.pbox.b+(this.ih/2));break;case"right":var l=(q-this.pbox.l)/this.iw;f=(l>this.subts)?1:q/(this.pbox.l+(this.iw/2));break;case"left":var l=(q-this.pbox.l)/this.iw;f=(l<this.subts)?1:(this.tw-q)/(this.pbox.r+(this.iw/2));break;default:f=this.isHor?(n/(this.th)):(f=q/(this.tw));if(f>this.subts){f=1-f}f*=2}for(var e=0;e<this.icnt;e++){var a=this.getChildAt(e),g=this._weighAt(k,e,a.$n());if(g<0){g=0}this._setItemSize(a.$n(),g*f)}var j=Math.round(k),d=0;if(k<0){j=0}else{if(k>this.icnt-1){j=this.icnt-1}else{d=(k-j)*((this.isHor?this.iw:this.ih)-this.getChildAt(j).$n().sizeMain)}}this._fixEl(j,d)},_weighAt:function(b,c,e){var d=Math.abs(b-c),a=((b-c)>0)?e.effectRangeRght:e.effectRangeLeft;return(d>a)?0:(1-d/a)},_setItemSize:function(f,d){d*=1;var b=Math.round(this.iw+((this.imw-this.iw)*d)),c=Math.round(this.ih+((this.imh-this.ih)*d));if(this.isHor){f.sizeMain=f.sizeW=b;f.sizeH=c;var e=0;if(this.aEdge=="top"){e=(f.cenY-(this.ih/2))}else{if(this.aEdge=="bottom"){e=(f.cenY-(c-(this.ih/2)))}else{e=(f.cenY-(c/2))}}f.usualX=Math.round(f.cenX-(b/2));f.style.top=e+"px";f.style.left=f.usualX+"px"}else{f.sizeW=b;f.sizeMain=f.sizeH=c;var a=0;if(this.aEdge=="left"){a=f.cenX-(this.iw/2)}else{if(this.aEdge=="right"){a=f.cenX-(b-(this.iw/2))}else{a=f.cenX-(b/2)}}f.style.left=a+"px";f.usualY=Math.round(f.cenY-(c/2));f.style.top=f.usualY+"px"}f.style.width=b+"px";f.style.height=c+"px"},_fixEl:function(d,e){var h=0,g=this.getChildAt(d),f=g.$n();if(this.isHor){h=Math.round(f.usualX+e);f.style.left=h+"px"}else{h=Math.round(f.usualY+e);f.style.top=h+"px"}this._fixLab(g);for(var a=h,b=d;--b>=0;){var g=this.getChildAt(b);var f=g.$n();a-=f.sizeMain;if(this.isHor){f.style.left=a+"px"}else{f.style.top=a+"px"}this._fixLab(g)}for(var c=h,b=d;++b<this.icnt;){var g=this.getChildAt(b);var f=g.$n();c+=this.getChildAt(b-1).$n().sizeMain;if(this.isHor){f.style.left=c+"px"}else{f.style.top=c+"px"}this._fixLab(g)}},_fixLab:function(i){var g=i.$n(),c=i.$n("label"),a=0,f=0,e=this.lEdge,d=i._mh+c.offsetHeight,b=i._mw+c.offsetWidth;if(!zk(c).isVisible()){return}switch(e){case"top":a=Math.round((g.sizeW/2)-(b/2));f=-d;break;case"bottom":a=Math.round((g.sizeW/2)-(b/2));f=g.sizeH;break;case"left":a=-b;f=Math.round((g.sizeH/2)-(d/2));break;case"right":a=g.sizeW;f=Math.round((g.sizeH/2)-(d/2));break}c.style.left=a+"px";c.style.top=f+"px"},onSize:function(){var a=zk(this.$n()).revisedOffset();this.box.l=a[0]-this.pbox.l;this.box.t=a[1]-this.pbox.t;this.box.r=this.box.l+this.tw;this.box.b=this.box.t+this.th}});