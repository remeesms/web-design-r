(function(){function e(j,m,g){var k=j.topHeight,l=j.leftWidth,i=j.custColWidth,f=j.custRowHeight;left=i.getStartPixel(g),t=f.getStartPixel(m),right=i.getStartPixel(g+1)-1,btm=f.getStartPixel(m+1)-1,w=right-left+1,h=btm-t+1;return{top:t+k,left:left+l,bottom:btm+k,right:right+l,width:w,height:h}}zssex.Popup=zk.$extends(zk.Widget,{$o:zk.$void,$init:function(f){this.$supers(zssex.Popup,"$init",[]);this.sheet=f},open:function(){},close:function(){this.setVisible(false)}});zssex.CellPopup=zk.$extends(zssex.Popup,{widgetName:"CellPopup",isOpen:function(){return this.$n()&&this.isVisible()},open:function(f,i){if(!this.isOpen()){var g=this.$n();if(!g){this.createPopup_()}this.relocate(f,i);this.setVisible(true)}},relocate:function(i,f){var g=e(this.sheet,i,f);jq(this.$n()).css({left:jq.px(g.left),top:jq.px(g.bottom),width:jq.px(g.width)})},createPopup_:function(){jq(this.sheet.$n("pp")).append(this.redrawHTML_());this.clearCache();this.bind_()},redrawHTML_:function(){return this.prologHTML_()+this.contentHTML_()+this.epilogHTML_()},contentHTML_:function(){return""},prologHTML_:function(){return"<div "+this.domAttrs_()+">"},epilogHTML_:function(){return"</div>"},listenSheetFocused_:function(f){var g=!!this._listenSheetFocused;if(g!=f){this.sheet[f?"listen":"unlisten"]({onFocused:this.proxy(this.onSheetFocused)});this._listenSheetFocused=f}},onSheetFocused:function(f){},listenSheetBlur_:function(f){var g=!!this._listenSheetBlur;if(g!=f){this.sheet._wgt[f?"listen":"unlisten"]({onBlur:this.proxy(this.onSheetBlur)});this._listenSheetBlur=f}},onSheetBlur:function(f){},getZclass:function(){return"zscellpopup"}});zssex.ValidationPromptPopup=zk.$extends(zssex.CellPopup,{widgetName:"ValidationPromptPopup",$init:function(f,i,g){this.$supers(zssex.ValidationPopup,"$init",arguments);this._pos={};this._title=i;this._text=g},unbind_:function(){delete this._pos;this._title=this._text=null;this.listenSheetFocused_(false);this.$supers(zssex.ValidationPromptPopup,"unbind_",arguments)},open:function(f,g){if(!this.isOpen()){this.$supers(zssex.ValidationPromptPopup,"open",arguments);if(zk.ie6_||zk.ie7_||zk.opera){jq(this.$n()).addClass("zsdvp-popup")}this.listenSheetFocused_(true)}},close:function(){var f=this;setTimeout(function(){f.listenSheetFocused_(false)});this.$supers(zssex.ValidationPromptPopup,"close",arguments)},relocate:function(q,g){var p=245,i=3,j=6,m=jq(this.$n());var l=this.sheet,f=e(this.sheet,q,g),o=this._pos;o.row=q;o.col=g;m.css({left:jq.px(f.right+i),top:jq.px(f.bottom+j)});if(!zk.ie6_&&!zk.ie7_){var k=zk.parseInt(m.width());if(k>p){m.width(jq.px(p))}}},onSheetFocused:function(f){var k=f.data,i=this._pos,g=k.col,j=k.row;if(i.row!=j||i.col!=g){this.close()}},contentHTML_:function(){var f=this.uuid,i=this._title,g=this._text;return'<div id="'+f+'-cave" class="zsdvp-popup-cave"><div id="'+f+'-title" class="zsdvp-title">'+(i?i:"")+'</div><div id="'+f+'-text" class="zsdvp-text">'+(g?g:"")+"</div></div>"}});function c(g){if(g.tagName.toLowerCase()=="a"){return g}var f=g.firstChild;return f&&f.tagName.toLowerCase()=="a"?f:null}function d(j,f,g){var i=g.state;g.state=zss.SSheetCtrl.FOCUSED;g.moveCellFocus(j,f,true);g.moveCellSelection(f,j,f,j,false,true);g.state=i}zssex.ValidationPopup=zk.$extends(zssex.CellPopup,{widgetName:"ValidationPopup",$init:function(f){this.$supers(zssex.ValidationPopup,"$init",arguments);this._pos={};this._validationList=[]},bind_:function(){this.$supers(zssex.ValidationPopup,"bind_",arguments);var f=this._validationList.length,g=this.$n();if(g){if(f>=8){jq(g).css({overflow:"auto",height:"155px"})}else{jq(g).css({overflow:"hidden",height:""})}}},unbind_:function(){delete this._pos;delete this._validationList;this.listenSheetBlur_(false);this.listenSheetFocused_(false);this.$supers(zssex.ValidationPopup,"unbind_",arguments)},_markSelectedItem:function(l,f){var i=this.sheet,k=i.getCell(l,f).getPureText(),j=this.$n("cave").firstChild;if(j){for(;j;j=j.nextSibling){var m=jq(j.firstChild),g=m.text();jq(j)[k==g?"addClass":"removeClass"]("zsdv-item-over")}}},open:function(f,g){if(this.isOpen()){this.close()}else{this.$supers(zssex.ValidationPopup,"open",arguments);this._markSelectedItem(f,g);this.listenSheetBlur_(true);this.listenSheetFocused_(true)}},close:function(){var f=this;setTimeout(function(){f.listenSheetBlur_(false);f.listenSheetFocused_(false);f.sheet.dp.gainFocus(false)});this.$supers(zssex.ValidationPopup,"close",arguments)},onSheetFocused:function(f){this.close()},relocate:function(m,f){var g=this.sheet,l=e(this.sheet,m,f),j=17,i=l.width+j,k=l.right+j-i,o=this._pos;o.row=m;o.col=f;jq(this.$n()).css({left:jq.px(k),top:jq.px(l.bottom),width:jq.px(i)})},setValidationList:function(k){var f=this._validationList,j=k.length,g=j;f.splice(0,f.length);while(g--){f[g]=k[g]}var m=this.$n();if(m){if(j>=8){jq(m).css({overflow:"auto",height:"155px"})}else{jq(m).css({overflow:"hidden",height:""})}}},contentHTML_:function(){var k=this.uuid,j='<ul id="'+k+'-cave" class="zsdv-popup-cave">',l=this._validationList,g=l.length;for(var f=0;f<g;f++){j+='<li class="zsdv-item"><a href="javascript:" class="zsdv-item-text">'+l[f]+"</a></li>"}j+='</ul><a id="'+k+'-fo" href="javascript:"></a>';return j},_editCell:function(l,f,k){var g=this.sheet,j=g.getCell(l,f).getPureText();if(j!=k){var i=g.state;if(g.state!=zss.SSheetCtrl.START_EDIT){g.state=zss.SSheetCtrl.START_EDIT;g._wgt.fire("onStartEditing",{token:"",sheetId:g.serverSheetId,row:l,col:f,clienttxt:k,type:"inlineEditing"},null,25)}g.state=i;g._wgt.fire("onStopEditing",{token:"",sheetId:g.serverSheetId,row:l,col:f,value:k,type:"inlineEditing"},{toServer:true},25)}},onSheetBlur:function(){if(this.isOpen()){var f=jq(this.$n()).find(".zsdv-item-over"),g=this._pos;row=g.row,col=g.col;if(f.length){jq(f[0].firstChild).focus()}else{jq(this.$n("fo")).focus()}d(g.row,g.col,this.sheet)}},doMouseOver_:_zkf=function(f){var g=c(f.domTarget);if(g){var i=jq(this.$n()).find(".zsdv-item-over");if(i.length){i.removeClass("zsdv-item-over")}jq(g.parentNode).addClass("zsdv-item-over")}},doMouseMove_:_zkf,doKeyPress_:function(f){},doMouseDown_:function(f){var i=c(f.domTarget);if(i){var g=this._pos;this._editCell(g.row,g.col,jq(i).text());this.close()}},doKeyDown_:function(j){var i=j.keyCode,l=document.activeElement==this.$n("fo"),o=null,k=null;switch(i){case 38:case 40:if(l){k=this.$n("cave").firstChild}else{o=jq(this.$n()).find(".zsdv-item-over");if(o.length){k=i==38?o[0].previousSibling:o[0].nextSibling}}if(k){jq(k).addClass("zsdv-item-over");jq(k.firstChild).focus()}if(k&&o){o.removeClass("zsdv-item-over")}break;case 13:var g=jq(this.$n()).find(".zsdv-item-over");if(g.length){var m=this._pos;this._editCell(m.row,m.col,jq(g[0]).text())}this.close();break;case 27:this.close();break}j.stop()}});function b(g){var f=jq(g);return f.hasClass("zsafp-item")?f[0]:f.hasClass("zsafp-item-checkbox")||(zk.ie6_&&f.hasClass("zsafp-item-text"))?f[0].parentNode:null}function a(i){if(i==null){return}var g=i.parentNode,f=g.firstChild;for(;f;f=f.nextSibling){if(f!=i){jq(f).removeClass("zsafp-item-over")}}jq(i).addClass("zsafp-item-over")}zssex.AutoFilterPopup=zk.$extends(zssex.CellPopup,{$init:function(g,f){this.$supers(zssex.AutoFilterPopup,"$init",arguments);this._pos={};this._field=f.field;this._rangeAddr=f.range;this._blank=f.blank;this._select=f.select;this._initItems(f.items,f.select,f.blank);this.setVisible(false)},_initItems:function(g,f,m){var l=this._items=[{v:zssex.AutoFilterPopup.SELECT_ALL,s:f}],k=g.length;for(var j=0;j<k;j++){l.push(g[j])}if(m!=undefined){l.push({v:zssex.AutoFilterPopup.BLANK,s:m})}},unbind_:function(){delete this._pos;delete this._items;delete this._$is;this.listenSheetFocused_(false);var f=this.$n("inp");this.domUnlisten_(f,"onKeyDown",this._onFilterKeyDown);this.domUnlisten_(f,"onKeyUp",this._onFilterKeyUp);this.$supers(zssex.AutoFilterPopup,"unbind_",arguments)},open:function(i,k){if(this.isOpen()){this.close()}else{this.$supers(zssex.AutoFilterPopup,"open",arguments);var g=this.$n("inp"),f=this._select,j=jq(this._$items()[0]);g.focus();this.sheet.state=zss.SSheetCtrl.NOFOCUS;this.domListen_(g,"onKeyDown",this._onFilterKeyDown);this.domListen_(g,"onKeyUp",this._onFilterKeyUp);if("all"==f){j.addClass("zsafp-item-seld")}else{if("mix"==f){j.addClass("zsafp-item-seld-mix")}}this.listenSheetFocused_(true)}},_$items:function(){if(!this._$is){this._$is=jq(this.$n("items")).children()}return this._$is},_onFilterKeyDown:function(f){this._prevFilterVal=f.domTarget.value},_onFilterKeyUp:function(g){var i=g.domTarget.value.toLowerCase(),f=this._prevFilterVal.length>i.length,j=this._$items();j.each(function(k,m){var l=jq(m);if(f){if(l.hasClass("zsafp-item-hide")){if(l.text().toLowerCase().indexOf(i)>=0){l.removeClass("zsafp-item-hide")}}}else{if(l.text().toLowerCase().indexOf(i)<0){l.addClass("zsafp-item-hide")}}})},close:function(){var f=this;setTimeout(function(){f.listenSheetFocused_(false);f.sheet.dp.gainFocus(false)});this.$supers(zssex.AutoFilterPopup,"close",arguments);this.detach()},contentHTML_:function(){var l=this.uuid,f=this._items,k=f.length,j='<div class="zsafp-popup-cave">';j+='<div class="zsafp-search"><div class="zsafp-search-cnt"><input id="'+l+'-inp" class="zsafp-search-inp" type="text" autocomplete="off" tabindex="0"></input><div class="zsafp-search-icon"></div></div></div>';j+='<div id="'+l+'-items" class="zsafp-items">';for(var g=0;g<k;g++){var m=f[g];j+='<div class="zsafp-item'+(m.s?" zsafp-item-seld":"")+'"><div class="zsafp-item-checkbox"></div>';if(zk.ie6_){j+='<div class="zsafp-item-text">'+m.v+"</div></div>"}else{j+=(m.v+"</div>")}}j+='</div><div id="'+l+'-btns" class="zsafp-btns"><div id="'+l+'-okBtn" class="zsafp-btn zsafp-ok-btn"></div><div id="'+l+'-cancelBtn" class="zsafp-btn zsafp-cancel-btn"></div></div></div>';return j},onSheetFocused:function(f){this.close()},relocate:function(m,f){var i=jq(this.$n());if((zk.ie6_||zk.ie7_)&&!i.width()){i.addClass("zsafp-popup")}var g=this.sheet,j=g.leftWidth,l=e(this.sheet,m,f),k=Math.max(j,l.right-zk.parseInt(i.width()));jq(this.$n()).css({left:jq.px(k),top:jq.px(l.bottom)})},doMouseOver_:function(f){a(b(f.domTarget))},doMouseMove_:function(f){},_selectNone:function(){var j=this._items,g=this._$items(),k=j.length;while(k--){var o=j[k],m=o.s,l=jq(g[k]);if(k==0){o.s="none";var f=jq(this.$n("okBtn"));if("mix"==m){l.removeClass("zsafp-item-seld-mix");f.addClass("zsafp-btn-disd")}else{if("all"==m){l.removeClass("zsafp-item-seld");f.addClass("zsafp-btn-disd")}}}else{o.s=false;if(m){l.removeClass("zsafp-item-seld")}}}},_selectAll:function(){var g=this._items,f=this._$items(),j=g.length;while(j--){var m=g[j],l=m.s,k=jq(f[j]);if(j==0){m.s="all";if("mix"==l){k.removeClass("zsafp-item-seld-mix").addClass("zsafp-item-seld")}else{if("none"==l){k.addClass("zsafp-item-seld");jq(this.$n("okBtn")).removeClass("zsafp-btn-disd")}}}else{m.s=true;if(!l){k.addClass("zsafp-item-seld")}}}},_isSelectAll:function(){return"all"==this._items[0].s},_isSelectNone:function(){return"none"==this._items[0].s},_updateSelectAllItem:function(){var g=this._items,j=g.length,l=true,f=false,o=this._items[0].s;while(j--){var m=g[j];if(j==0){var k=jq(this._$items()[0]);if(l){k.addClass("zsafp-item-seld");m.s="all"}else{if(f){k.addClass("zsafp-item-seld-mix");m.s="mix"}else{m.s="none";jq(this.$n("okBtn")).addClass("zsafp-btn-disd")}}if(o!=m.s){if("all"==o){k.removeClass("zsafp-item-seld")}else{if("mix"==o){k.removeClass("zsafp-item-seld-mix")}else{jq(this.$n("okBtn")).removeClass("zsafp-btn-disd")}}}}else{if(m.s){f=true}else{l=false}}}},_clickItem:function(o){var f=this._items,m=f.length,g=0,l=false;n=this._$items()[0];for(;n;n=n.nextSibling,g++){if(n==o){var k=f[g];if(g==0){var j=k.s;if("all"==j){this._selectNone()}else{if("mix"==j||"none"==j){this._selectAll()}}}else{l=true;jq(o)[k.s?"removeClass":"addClass"]("zsafp-item-seld");k.s=!k.s}break}}if(l){this._updateSelectAllItem()}},_isButton:function(i){var f=this.$n("okBtn"),g=this.$n("cancelBtn");if(zUtl.isAncestor(f,i)){return"ok"}else{if(zUtl.isAncestor(g,i)){return"cancel"}}},doMouseDown_:function(g){var k=g.domTarget,i=this._isButton(k);if(i){if("ok"==i){if(!this._isSelectNone()){this._applyFilter();this.close()}}else{if("cancel"==i){this.close()}}return}var l=b(k),j=this.$n("inp");if(l){this._clickItem(l)}setTimeout(function(){j.focus()},0)},doKeyPress_:function(f){},_getCriteria:function(){var g=[],f=this._items,k=f.length,m=k-1,o=this._blank;for(var j=1;j<k;j++){var l=f[j];if(j==m&&o!=undefined){if(l.s){g.push("=")}}else{if(l.s){g.push(l.v)}}}return g},_applyFilter:function(){var f={type:"onApplyFilter",field:this._field,range:this._rangeAddr};f.all=this._isSelectAll();if(!f.all){f.criteria=this._getCriteria()}this.sheet._wgt.fire("onZSSFilter",f,{toServer:true})},_prevVisibleItem:function(g){for(var f=g.previousSibling;f;f=f.previousSibling){if(f&&f.className.indexOf("zsafp-item-hide")<0){return f}}},_nextVisibleItem:function(g){for(var f=g.nextSibling;f;f=f.nextSibling){if(f&&f.className.indexOf("zsafp-item-hide")<0){return f}}},_firstVisibleItem:function(){for(var f=this._$items()[0];f;f=f.nextSibling){if(f&&f.className.indexOf("zsafp-item-hide")<0){return f}}},doKeyDown_:function(g){var f=g.keyCode;switch(f){case 38:case 40:var i=this.$n("items"),j=jq(i).children(".zsafp-item-over")[0];if(j){var k=(f==38)?this._prevVisibleItem(j):this._nextVisibleItem(j);if(k){jq(k).addClass("zsafp-item-over");jq(j).removeClass("zsafp-item-over")}}else{jq(this._firstVisibleItem()).addClass("zsafp-item-over")}break;case 13:if(!this._isSelectNone()){this._applyFilter();this.close()}break;case 27:this.close()}}},{SELECT_ALL:"(Select All)",BLANK:"(Blanks)"})})();